<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes"/>
  <title>Admin Panel - QuestCord</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    html, body { 
      height: 100%; 
      margin: 0; 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      min-height: 100vh;
      box-sizing: border-box;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      color: #333;
    }
    
    .header h1 {
      margin: 0 0 10px 0;
      font-size: 2.5rem;
      color: #333;
      font-weight: 700;
    }
    
    .back-btn {
      display: inline-block;
      background: rgba(255,255,255,0.2);
      color: white;
      padding: 10px 20px;
      border-radius: 25px;
      text-decoration: none;
      margin-bottom: 20px;
      transition: background 0.3s;
      font-weight: 600;
    }
    
    .back-btn:hover {
      background: rgba(255,255,255,0.3);
      text-decoration: none;
      color: white;
    }
    
    .admin-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .admin-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      transition: transform 0.2s ease;
      color: #333;
    }
    
    .admin-card:hover {
      transform: translateY(-5px);
    }
    
    .card-title {
      font-size: 1.4rem;
      font-weight: 700;
      margin-bottom: 20px;
      color: #333;
      padding-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    h1, h2, h3, h4, h5, h6, .card-title, .title, .stat-number {
      color: #333 !important;
      font-weight: 700 !important;
    }
    
    p, span, div, label, .stat-label, .form-group label, .user-details p {
      color: #333 !important;
    }
    
    .user-management .card-title {
      border-bottom: 3px solid #e74c3c;
    }
    
    .server-management .card-title {
      border-bottom: 3px solid #f39c12;
    }
    
    .gems-management .card-title {
      border-bottom: 3px solid #9b59b6;
    }
    
    .item-management .card-title {
      border-bottom: 3px solid #8e44ad;
    }
    
    .boss-management .card-title {
      border-bottom: 3px solid #e74c3c;
    }
    
    .system-tools .card-title {
      border-bottom: 3px solid #27ae60;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #333;
    }
    
    .form-control {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.2s ease;
      box-sizing: border-box;
      background: white;
      color: #333;
    }
    
    .form-control:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-right: 10px;
      margin-bottom: 10px;
      text-decoration: none;
      display: inline-block;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: white;
    }
    
    .btn-success {
      background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
      color: white;
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: white;
    }
    
    .btn-warning {
      background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
      color: white;
    }
    
    .btn-info {
      background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
      color: white;
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
      color: white;
    }
    
    .result-box {
      margin-top: 15px;
      padding: 12px 15px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      display: none;
    }
    
    .result-success {
      background: rgba(39, 174, 96, 0.1);
      border: 2px solid #27ae60;
      color: #27ae60;
    }
    
    .result-error {
      background: rgba(231, 76, 60, 0.1);
      border: 2px solid #e74c3c;
      color: #e74c3c;
    }
    
    .result-warning {
      background: rgba(243, 156, 18, 0.1);
      border: 2px solid #f39c12;
      color: #e67e22;
    }
    
    .result-info {
      background: rgba(52, 152, 219, 0.1);
      border: 2px solid #3498db;
      color: #2980b9;
    }
    
    .user-info, .server-info {
      background: rgba(0, 0, 0, 0.05);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      display: none;
    }
    
    .user-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 2px solid #3498db;
      margin-right: 15px;
      float: left;
    }
    
    .user-details h4 {
      margin: 0 0 5px 0;
      color: #333 !important;
    }
    
    .user-details p {
      margin: 2px 0;
      color: #666 !important;
      font-size: 13px;
    }
    
    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      margin-left: 10px;
    }
    
    .status-active {
      background: #d4edda;
      color: #155724;
    }
    
    .status-banned {
      background: #f8d7da;
      color: #721c24;
    }
    
    .status-archived {
      background: #fff3cd;
      color: #856404;
    }
    
    .error-message {
      background: rgba(231, 76, 60, 0.1);
      border: 2px solid #e74c3c;
      color: #c0392b;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      margin: 20px 0;
      font-weight: 600;
    }
    
    .loading {
      text-align: center;
      padding: 50px;
      font-size: 1.2rem;
      color: #666;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: rgba(0, 0, 0, 0.05);
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }
    
    .stat-number {
      font-size: 1.8rem;
      font-weight: 700;
      color: #333 !important;
      margin-bottom: 5px;
    }
    
    .stat-label {
      font-size: 0.9rem;
      color: #666 !important;
      text-transform: uppercase;
      font-weight: 600;
    }
    
    @media (max-width: 768px) {
      .admin-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      .container {
        padding: 15px;
      }
      
      .header h1 {
        font-size: 2rem;
      }
      
      .form-control {
        font-size: 16px; /* Prevents zoom on iOS */
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div style="text-align: center; margin-bottom: 20px;">
      <a href="/" class="back-btn">‚Üê Back to Map</a>
    </div>
    
    <div class="header">
      <h1>Admin Control Panel</h1>
      <p>Staff and Developer Management Tools</p>
    </div>
    
    <div id="loading" class="loading">
      Loading admin panel...
    </div>
    
    <div id="error" class="error-message" style="display: none;">
      Access denied. Staff or Developer role required.
    </div>
    
    <div id="adminPanel" style="display: none;">
      <div class="admin-grid">
        <!-- User Management -->
        <div class="admin-card user-management">
          <div class="card-title">
            <span>User</span>
            User Management
          </div>
          
          <div class="form-group">
            <label>User ID (Discord ID)</label>
            <input type="text" id="userLookupId" class="form-control" placeholder="Enter Discord user ID">
          </div>
          
          <button class="btn btn-info" id="lookupUserBtn">Lookup User</button>
          
          <div id="userInfo" class="user-info">
            <!-- User info will be populated here -->
          </div>
          
          <div class="form-group" style="margin-top: 20px;">
            <label>Ban Reason (optional)</label>
            <input type="text" id="banReason" class="form-control" placeholder="Reason for ban/action">
          </div>
          
          <button class="btn btn-danger" id="banUserBtn" disabled>Ban User</button>
          <button class="btn btn-success" id="unbanUserBtn" disabled>Unban User</button>
          <button class="btn btn-warning" id="kickUserBtn" disabled>Kick from All Servers</button>
          
          <h5 style="margin: 20px 0 10px 0; color: #17a2b8;">Stats Management</h5>
          <button class="btn btn-secondary" id="resetAllStatsBtn" disabled>Reset All Stats</button>
          <button class="btn btn-info" id="resetTravelStatsBtn" disabled>Reset Travel Stats</button>
          <button class="btn btn-warning" id="resetBattleStatsBtn" disabled>Reset Battle Stats</button>
          <button class="btn btn-danger" id="resetAchievementsBtn" disabled>Reset Achievements</button>
          
          <div id="userResult" class="result-box"></div>
        </div>
        
        <!-- Server Management -->
        <div class="admin-card server-management">
          <div class="card-title">
            <span>Server</span>
            Server Management
          </div>
          
          <div class="form-group">
            <label>Server ID (Guild ID)</label>
            <input type="text" id="serverLookupId" class="form-control" placeholder="Enter Discord guild ID">
          </div>
          
          <button class="btn btn-info" id="lookupServerBtn">Lookup Server</button>
          
          <div id="serverInfo" class="server-info">
            <!-- Server info will be populated here -->
          </div>
          
          <div class="form-group" style="margin-top: 20px;">
            <label>Action Reason (optional)</label>
            <input type="text" id="serverReason" class="form-control" placeholder="Reason for server action">
          </div>
          
          <button class="btn btn-danger" id="banServerBtn" disabled>Ban Server</button>
          <button class="btn btn-success" id="unbanServerBtn" disabled>Unban Server</button>
          <button class="btn btn-warning" id="archiveServerBtn" disabled>Archive Server</button>
          <button class="btn btn-info" id="restoreServerBtn" disabled>Restore Server</button>
          
          <div id="serverResult" class="result-box"></div>
        </div>
        
        <!-- Currency Management -->
        <div class="admin-card gems-management">
          <div class="card-title">
            <span>Currency</span>
            Currency Management
          </div>
          
          <div class="form-group">
            <label>User ID (for gems) / Server ID (for tokens)</label>
            <input type="text" id="currencyTargetId" class="form-control" placeholder="Discord user ID or guild ID">
          </div>
          
          <div class="form-group">
            <label>Amount</label>
            <input type="number" id="currencyAmount" class="form-control" placeholder="Amount" min="1">
          </div>
          
          <div class="form-group">
            <label>Reason (optional)</label>
            <input type="text" id="currencyReason" class="form-control" placeholder="Reason for action">
          </div>
          
          <h5 style="margin: 20px 0 10px 0; color: #9b59b6;">Gems (User Currency)</h5>
          <button class="btn btn-info" id="checkGemsBtn">Check Gems</button>
          <button class="btn btn-success" id="addGemsBtn">Add Gems</button>
          <button class="btn btn-danger" id="removeGemsBtn">Remove Gems</button>
          
          <h5 style="margin: 20px 0 10px 0; color: #f39c12;">Tokens (Server Currency)</h5>
          <button class="btn btn-info" id="checkTokensBtn">Check Tokens</button>
          <button class="btn btn-success" id="addTokensBtn">Add Tokens</button>
          <button class="btn btn-danger" id="removeTokensBtn">Remove Tokens</button>
          
          <div id="currencyResult" class="result-box"></div>
        </div>
        
        <!-- Item Management -->
        <div class="admin-card item-management">
          <div class="card-title">
            <span>Items</span>
            Item Management
          </div>
          
          <div class="form-group">
            <label>User ID</label>
            <input type="text" id="itemUserId" class="form-control" placeholder="Discord user ID">
          </div>
          
          <div class="form-group">
            <label>Item ID</label>
            <input type="text" id="itemId" class="form-control" placeholder="Item identifier">
          </div>
          
          <div class="form-group">
            <label>Quantity</label>
            <input type="number" id="itemQuantity" class="form-control" placeholder="Quantity" min="1" value="1">
          </div>
          
          <div class="form-group">
            <label>Reason (optional)</label>
            <input type="text" id="itemReason" class="form-control" placeholder="Reason for action">
          </div>
          
          <h5 style="margin: 20px 0 10px 0; color: #8e44ad;">Inventory Actions</h5>
          <button class="btn btn-info" id="checkInventoryBtn">Check Inventory</button>
          <button class="btn btn-success" id="addItemBtn">Add Item</button>
          <button class="btn btn-danger" id="removeItemBtn">Remove Item</button>
          <button class="btn btn-warning" id="clearInventoryBtn">Clear All Items</button>
          
          <div id="itemResult" class="result-box"></div>
        </div>
        
        <!-- Boss Management -->
        <div class="admin-card boss-management">
          <div class="card-title">
            <span>Boss</span>
            Boss Management
          </div>
          
          <div class="form-group">
            <label>Server ID</label>
            <input type="text" id="bossServerId" class="form-control" placeholder="Discord guild ID">
          </div>
          
          <div class="form-group">
            <label>Boss Name (optional)</label>
            <input type="text" id="bossName" class="form-control" placeholder="Leave empty for biome-based name">
          </div>
          
          <div class="form-group">
            <label>Boss Tier (1-5)</label>
            <input type="number" id="bossTier" class="form-control" placeholder="Tier level" min="1" max="5" value="1">
          </div>
          
          <div class="form-group">
            <label>Health Multiplier</label>
            <input type="number" id="bossHealthMultiplier" class="form-control" placeholder="Health multiplier" min="0.1" max="5" step="0.1" value="1">
          </div>
          
          <div class="form-group">
            <label>Duration (minutes)</label>
            <input type="number" id="bossDuration" class="form-control" placeholder="Boss duration in minutes" min="1" max="480" value="60">
          </div>
          
          <h5 style="margin: 20px 0 10px 0; color: #e74c3c;">Boss Actions</h5>
          <button class="btn btn-info" id="listActiveBossesBtn">List Active Bosses</button>
          <button class="btn btn-success" id="spawnBossBtn">Spawn Boss</button>
          <button class="btn btn-danger" id="killBossBtn">Kill Boss</button>
          <button class="btn btn-warning" id="extendBossBtn">Extend Duration</button>
          
          <div id="bossResult" class="result-box"></div>
        </div>
        
        <!-- System Tools -->
        <div class="admin-card system-tools">
          <div class="card-title">
            <span>System</span>
            System Tools
          </div>
          
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-number" id="totalUsers">-</div>
              <div class="stat-label">Total Users</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="totalServers">-</div>
              <div class="stat-label">Total Servers</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="bannedUsers">-</div>
              <div class="stat-label">Banned Users</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="archivedServers">-</div>
              <div class="stat-label">Archived Servers</div>
            </div>
          </div>
          
          <button class="btn btn-primary" id="refreshStatsBtn">Refresh Stats</button>
          <button class="btn btn-info" id="exportDataBtn">Export Data</button>
          <button class="btn btn-warning" id="clearCacheBtn">Clear Cache</button>
          <button class="btn btn-secondary" id="systemStatusBtn">System Status</button>
          
          <div id="systemResult" class="result-box"></div>
        </div>

        <!-- Weather Management -->
        <div class="admin-card weather-management">
          <div class="card-title">
            <span>Weather</span>
            Weather System Management
          </div>
          
          <div class="form-group">
            <button class="btn btn-info" id="listWeatherBtn">List Active Weather</button>
            <button class="btn btn-success" id="generateWeatherBtn">Generate Random Weather</button>
            <button class="btn btn-danger" id="clearWeatherBtn">Clear All Weather</button>
          </div>

          <h5 style="margin: 20px 0 10px 0; color: #3498db;">Create Weather Event</h5>
          
          <div class="form-group">
            <label>Weather Type</label>
            <select id="weatherType" class="form-control">
              <option value="cyclone">Cyclone (Blocks travel)</option>
              <option value="thunderstorm">Thunderstorm (Slows travel)</option>
              <option value="blizzard">Blizzard (Blocks travel)</option>
              <option value="hurricane">Hurricane (Blocks travel)</option>
              <option value="dense_fog">Dense Fog (Slows travel)</option>
              <option value="heavy_rain">Heavy Rain (Slows travel)</option>
              <option value="ice_storm">Ice Storm (Blocks travel)</option>
              <option value="wildfire">Wildfire (Blocks travel)</option>
              <option value="tornado">Tornado (Blocks travel)</option>
              <option value="high_winds">High Winds (Slows travel)</option>
              <option value="avalanche">Avalanche (Blocks travel)</option>
              <option value="lightning_storm">Lightning Storm (Slows travel)</option>
              <option value="volcanic_ash">Volcanic Ash (Blocks travel)</option>
              <option value="dust_storm">Dust Storm (Slows travel)</option>
            </select>
          </div>

          <div style="display: flex; gap: 10px;">
            <div class="form-group" style="flex: 1;">
              <label>Latitude (-90 to 90)</label>
              <input type="number" id="weatherLat" class="form-control" placeholder="0.0" min="-90" max="90" step="0.001">
            </div>
            <div class="form-group" style="flex: 1;">
              <label>Longitude (-180 to 180)</label>
              <input type="number" id="weatherLon" class="form-control" placeholder="0.0" min="-180" max="180" step="0.001">
            </div>
          </div>

          <div style="display: flex; gap: 10px;">
            <div class="form-group" style="flex: 1;">
              <label>Duration (minutes, 10-1440)</label>
              <input type="number" id="weatherDuration" class="form-control" placeholder="60" min="10" max="1440" value="60">
            </div>
            <div class="form-group" style="flex: 1;">
              <label>Radius (km, 25-500, optional)</label>
              <input type="number" id="weatherRadius" class="form-control" placeholder="Auto" min="25" max="500">
            </div>
          </div>

          <button class="btn btn-primary" id="createWeatherBtn">Create Weather Event</button>

          <h5 style="margin: 20px 0 10px 0; color: #3498db;">Regional Weather</h5>
          
          <div style="display: flex; gap: 10px;">
            <div class="form-group" style="flex: 2;">
              <label>Country/Region</label>
              <select id="weatherCountry" class="form-control">
                <option value="">Select a country/region</option>
                <option value="usa">United States</option>
                <option value="canada">Canada</option>
                <option value="uk">United Kingdom</option>
                <option value="germany">Germany</option>
                <option value="france">France</option>
                <option value="japan">Japan</option>
                <option value="australia">Australia</option>
                <option value="brazil">Brazil</option>
                <option value="china">China</option>
                <option value="india">India</option>
                <option value="russia">Russia</option>
                <option value="mexico">Mexico</option>
                <option value="spain">Spain</option>
                <option value="italy">Italy</option>
                <option value="norway">Norway</option>
                <option value="sweden">Sweden</option>
                <option value="finland">Finland</option>
                <option value="iceland">Iceland</option>
                <option value="greenland">Greenland</option>
                <option value="south africa">South Africa</option>
                <option value="egypt">Egypt</option>
                <option value="antarctica">Antarctica</option>
                <option value="pacific">Pacific Ocean</option>
                <option value="atlantic">Atlantic Ocean</option>
              </select>
            </div>
            <div class="form-group" style="flex: 1;">
              <label>Weather Type</label>
              <select id="regionalWeatherType" class="form-control">
                <option value="cyclone">Cyclone</option>
                <option value="thunderstorm">Thunderstorm</option>
                <option value="blizzard">Blizzard</option>
                <option value="hurricane">Hurricane</option>
                <option value="dense_fog">Dense Fog</option>
                <option value="heavy_rain">Heavy Rain</option>
                <option value="ice_storm">Ice Storm</option>
                <option value="wildfire">Wildfire</option>
              </select>
            </div>
          </div>

          <button class="btn btn-warning" id="createRegionalWeatherBtn">Create Regional Weather</button>

          <h5 style="margin: 20px 0 10px 0; color: #e74c3c;">Weather Management</h5>
          
          <div class="form-group">
            <label>Weather Event ID (to remove)</label>
            <input type="text" id="weatherEventId" class="form-control" placeholder="Enter weather event ID">
            <button class="btn btn-danger" id="removeWeatherBtn">Remove Weather Event</button>
          </div>

          <div id="weatherResult" class="result-box"></div>
          <div id="weatherList" style="margin-top: 15px; max-height: 300px; overflow-y: auto;"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let CSRF = null;
    let currentUser = null;

    async function getCsrf() {
      try {
        const r = await fetch('/api/csrf');
        const j = await r.json();
        CSRF = j.csrf;
      } catch (e) {
        console.error('Failed to get CSRF token:', e);
      }
    }

    async function checkAccess() {
      try {
        const response = await fetch('/api/whoami');
        const data = await response.json();
        
        if (!data.user) {
          showError('Please sign in to access the admin panel.');
          return false;
        }

        currentUser = data;
        
        if (!(data.roleLevel === 'Developer' || data.roleLevel === 'Staff')) {
          showError('Access denied. Staff or Developer role required.');
          return false;
        }

        return true;
      } catch (error) {
        showError('Failed to verify access permissions.');
        return false;
      }
    }

    function showError(message) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').textContent = message;
      document.getElementById('error').style.display = 'block';
    }

    function showResult(elementId, message, type = 'info') {
      const element = document.getElementById(elementId);
      element.textContent = message;
      element.className = `result-box result-${type}`;
      element.style.display = 'block';
      setTimeout(() => {
        element.style.display = 'none';
      }, 5000);
    }

    async function lookupUser() {
      const userId = document.getElementById('userLookupId').value.trim();
      if (!userId) {
        showResult('userResult', 'Please enter a user ID', 'error');
        return;
      }

      try {
        const response = await fetch(`/api/admin/user/lookup/${userId}`);
        const data = await response.json();
        
        if (response.ok) {
          displayUserInfo(data);
          enableUserButtons(true);
        } else {
          showResult('userResult', data.message || 'User not found', 'error');
          document.getElementById('userInfo').style.display = 'none';
          enableUserButtons(false);
        }
      } catch (error) {
        showResult('userResult', 'Network error', 'error');
        enableUserButtons(false);
      }
    }

    function displayUserInfo(data) {
      const userInfo = document.getElementById('userInfo');
      const isBanned = data.banned || false;
      
      userInfo.innerHTML = `
        <div style="overflow: hidden;">
          <img src="${data.avatar || 'https://cdn.discordapp.com/embed/avatars/0.png'}" class="user-avatar" alt="Avatar">
          <div class="user-details">
            <h4>${data.username || 'Unknown User'} 
              <span class="status-badge ${isBanned ? 'status-banned' : 'status-active'}">
                ${isBanned ? 'BANNED' : 'ACTIVE'}
              </span>
            </h4>
            <p><strong>ID:</strong> ${data.userId}</p>
            <p><strong>Role:</strong> ${data.roleLevel || 'User'}</p>
            <p><strong>Gems:</strong> ${data.gems || 0}</p>
            <p><strong>Health:</strong> ${data.health || 0}/100</p>
            <p><strong>Current Server:</strong> ${data.currentServer || 'Unknown'}</p>
            ${isBanned ? `<p><strong>Ban Reason:</strong> ${data.banReason || 'No reason provided'}</p>` : ''}
          </div>
        </div>
      `;
      userInfo.style.display = 'block';
    }

    function enableUserButtons(enabled) {
      document.getElementById('banUserBtn').disabled = !enabled;
      document.getElementById('unbanUserBtn').disabled = !enabled;
      document.getElementById('kickUserBtn').disabled = !enabled;
      
      // Stats management buttons
      document.getElementById('resetAllStatsBtn').disabled = !enabled;
      document.getElementById('resetTravelStatsBtn').disabled = !enabled;
      document.getElementById('resetBattleStatsBtn').disabled = !enabled;
      document.getElementById('resetAchievementsBtn').disabled = !enabled;
    }

    async function performStatsReset(resetType) {
      const userId = document.getElementById('userLookupId').value.trim();
      const reason = document.getElementById('banReason').value.trim();

      if (!userId) {
        showResult('userResult', 'Please lookup a user first', 'error');
        return;
      }

      const resetNames = {
        'all': 'ALL user stats',
        'travel': 'travel stats',
        'battle': 'battle stats',
        'achievements': 'achievements'
      };

      const resetName = resetNames[resetType] || resetType;
      
      if (!confirm(`Are you sure you want to reset ${resetName} for user ${userId}? This action cannot be undone.`)) {
        return;
      }

      try {
        const response = await fetch('/api/admin/user/reset-stats', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-csrf': CSRF || ''
          },
          body: JSON.stringify({
            userId,
            resetType,
            reason: reason || `Admin stats reset: ${resetType}`
          })
        });

        const data = await response.json();
        
        if (response.ok) {
          const completedText = data.operationsCompleted === data.totalOperations ? 'Successfully' : 'Partially';
          const errorText = data.errors ? `\nErrors: ${data.errors.join(', ')}` : '';
          showResult('userResult', 
            `${completedText} reset ${resetName} for user ${userId}. ${data.operationsCompleted}/${data.totalOperations} operations completed.${errorText}`, 
            data.errors ? 'warning' : 'success'
          );
        } else {
          showResult('userResult', data.message || `Failed to reset ${resetName}`, 'error');
        }
      } catch (error) {
        showResult('userResult', 'Network error while resetting stats', 'error');
      }
    }

    async function loadStats() {
      try {
        const response = await fetch('/api/admin/stats');
        const data = await response.json();
        
        if (response.ok) {
          document.getElementById('totalUsers').textContent = data.totalUsers || 0;
          document.getElementById('totalServers').textContent = data.totalServers || 0;
          document.getElementById('bannedUsers').textContent = data.bannedUsers || 0;
          document.getElementById('archivedServers').textContent = data.archivedServers || 0;
        }
      } catch (error) {
        console.error('Failed to load stats:', error);
      }
    }

    // Initialize admin panel
    async function init() {
      await getCsrf();
      
      if (await checkAccess()) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'block';
        await loadStats();
        setupEventListeners();
      }
    }

    function setupEventListeners() {
      // User management
      document.getElementById('lookupUserBtn').addEventListener('click', lookupUser);
      document.getElementById('banUserBtn').addEventListener('click', () => performUserAction('ban'));
      document.getElementById('unbanUserBtn').addEventListener('click', () => performUserAction('unban'));
      document.getElementById('kickUserBtn').addEventListener('click', () => performUserAction('kick'));
      
      // Stats management
      document.getElementById('resetAllStatsBtn').addEventListener('click', () => performStatsReset('all'));
      document.getElementById('resetTravelStatsBtn').addEventListener('click', () => performStatsReset('travel'));
      document.getElementById('resetBattleStatsBtn').addEventListener('click', () => performStatsReset('battle'));
      document.getElementById('resetAchievementsBtn').addEventListener('click', () => performStatsReset('achievements'));
      
      // Server management
      document.getElementById('lookupServerBtn').addEventListener('click', lookupServer);
      document.getElementById('banServerBtn').addEventListener('click', () => performServerAction('ban'));
      document.getElementById('unbanServerBtn').addEventListener('click', () => performServerAction('unban'));
      document.getElementById('archiveServerBtn').addEventListener('click', () => performServerAction('archive'));
      document.getElementById('restoreServerBtn').addEventListener('click', () => performServerAction('restore'));
      
      // Currency management
      document.getElementById('checkGemsBtn').addEventListener('click', () => performCurrencyAction('check', 'gems'));
      document.getElementById('addGemsBtn').addEventListener('click', () => performCurrencyAction('add', 'gems'));
      document.getElementById('removeGemsBtn').addEventListener('click', () => performCurrencyAction('remove', 'gems'));
      document.getElementById('checkTokensBtn').addEventListener('click', () => performCurrencyAction('check', 'tokens'));
      document.getElementById('addTokensBtn').addEventListener('click', () => performCurrencyAction('add', 'tokens'));
      document.getElementById('removeTokensBtn').addEventListener('click', () => performCurrencyAction('remove', 'tokens'));
      
      // Item management
      document.getElementById('checkInventoryBtn').addEventListener('click', () => performItemAction('check'));
      document.getElementById('addItemBtn').addEventListener('click', () => performItemAction('add'));
      document.getElementById('removeItemBtn').addEventListener('click', () => performItemAction('remove'));
      document.getElementById('clearInventoryBtn').addEventListener('click', () => performItemAction('clear'));
      
      // Boss management
      document.getElementById('listActiveBossesBtn').addEventListener('click', () => performBossAction('list'));
      document.getElementById('spawnBossBtn').addEventListener('click', () => performBossAction('spawn'));
      document.getElementById('killBossBtn').addEventListener('click', () => performBossAction('kill'));
      document.getElementById('extendBossBtn').addEventListener('click', () => performBossAction('extend'));
      
      // System tools
      document.getElementById('refreshStatsBtn').addEventListener('click', loadStats);
      document.getElementById('generateWeatherBtn').addEventListener('click', generateWeather);
      
      // Weather management
      document.getElementById('listWeatherBtn').addEventListener('click', listActiveWeather);
      document.getElementById('clearWeatherBtn').addEventListener('click', clearAllWeather);
      document.getElementById('createWeatherBtn').addEventListener('click', createWeatherEvent);
      document.getElementById('createRegionalWeatherBtn').addEventListener('click', createRegionalWeather);
      document.getElementById('removeWeatherBtn').addEventListener('click', removeWeatherEvent);
      
      // Enter key support
      document.getElementById('userLookupId').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') lookupUser();
      });
      document.getElementById('serverLookupId').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') lookupServer();
      });
    }

    async function performUserAction(action) {
      const userId = document.getElementById('userLookupId').value.trim();
      const reason = document.getElementById('banReason').value.trim();
      
      if (!userId) {
        showResult('userResult', 'Please lookup a user first', 'error');
        return;
      }

      if (action === 'ban' && !confirm(`Are you sure you want to ban user ${userId}?`)) {
        return;
      }
      
      if (action === 'kick' && !confirm(`Are you sure you want to kick user ${userId} from ALL servers? This will remove them from every Discord server the bot manages.`)) {
        return;
      }

      try {
        const response = await fetch(`/api/admin/user/${action}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-csrf': CSRF || ''
          },
          body: JSON.stringify({ userId, reason })
        });

        const data = await response.json();
        
        if (response.ok) {
          if (action === 'kick') {
            const kickedCount = data.kickedFromServers || 0;
            const totalServers = data.totalServers || 0;
            showResult('userResult', `User kicked from ${kickedCount}/${totalServers} servers successfully`, 'success');
          } else {
            showResult('userResult', `User ${action}ned successfully`, 'success');
          }
          // Refresh user info
          await lookupUser();
        } else {
          showResult('userResult', data.message || `Failed to ${action} user`, 'error');
        }
      } catch (error) {
        showResult('userResult', 'Network error', 'error');
      }
    }

    // Server management functions
    async function lookupServer() {
      const guildId = document.getElementById('serverLookupId').value.trim();
      if (!guildId) {
        showResult('serverResult', 'Please enter a server ID', 'error');
        return;
      }

      try {
        const response = await fetch(`/api/admin/server/lookup/${guildId}`);
        const data = await response.json();
        
        if (response.ok) {
          displayServerInfo(data);
          enableServerButtons(true);
        } else {
          showResult('serverResult', data.message || 'Server not found', 'error');
          document.getElementById('serverInfo').style.display = 'none';
          enableServerButtons(false);
        }
      } catch (error) {
        showResult('serverResult', 'Network error', 'error');
        enableServerButtons(false);
      }
    }

    function displayServerInfo(data) {
      const serverInfo = document.getElementById('serverInfo');
      const isBanned = data.banned || false;
      const isArchived = data.archived || false;
      
      serverInfo.innerHTML = `
        <div style="overflow: hidden;">
          <img src="${data.iconUrl || 'https://cdn.discordapp.com/embed/avatars/0.png'}" class="user-avatar" alt="Server Icon">
          <div class="user-details">
            <h4>${data.name || 'Unknown Server'} 
              <span class="status-badge ${isBanned ? 'status-banned' : isArchived ? 'status-archived' : 'status-active'}">
                ${isBanned ? 'BANNED' : isArchived ? 'ARCHIVED' : 'ACTIVE'}
              </span>
            </h4>
            <p><strong>ID:</strong> ${data.guildId}</p>
            <p><strong>Members:</strong> ${data.memberCount || 0}</p>
            <p><strong>Visitors:</strong> ${data.visitors || 0}</p>
            <p><strong>Tokens:</strong> ${data.tokens || 0}</p>
            <p><strong>Location:</strong> ${data.lat?.toFixed(4)}, ${data.lon?.toFixed(4)} (${data.biome || 'Unknown'})</p>
            ${isBanned ? `<p><strong>Ban Reason:</strong> ${data.banReason || 'No reason provided'}</p>` : ''}
          </div>
        </div>
      `;
      serverInfo.style.display = 'block';
    }

    function enableServerButtons(enabled) {
      document.getElementById('banServerBtn').disabled = !enabled;
      document.getElementById('unbanServerBtn').disabled = !enabled;
      document.getElementById('archiveServerBtn').disabled = !enabled;
      document.getElementById('restoreServerBtn').disabled = !enabled;
    }

    async function performServerAction(action) {
      const guildId = document.getElementById('serverLookupId').value.trim();
      const reason = document.getElementById('serverReason').value.trim();
      
      if (!guildId) {
        showResult('serverResult', 'Please lookup a server first', 'error');
        return;
      }

      if (action === 'ban' && !confirm(`Are you sure you want to ban server ${guildId}?`)) {
        return;
      }

      try {
        let endpoint = '';
        if (action === 'archive') {
          endpoint = '/api/admin/server-archive';
        } else if (action === 'restore') {
          endpoint = '/api/admin/server-restore';
        } else {
          endpoint = `/api/admin/server/${action}`;
        }

        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-csrf': CSRF || ''
          },
          body: JSON.stringify({ guildId, reason })
        });

        const data = await response.json();
        
        if (response.ok) {
          showResult('serverResult', `Server ${action}ed successfully`, 'success');
          await lookupServer(); // Refresh server info
        } else {
          showResult('serverResult', data.message || `Failed to ${action} server`, 'error');
        }
      } catch (error) {
        showResult('serverResult', 'Network error', 'error');
      }
    }

    // Currency management functions
    async function performCurrencyAction(action, type) {
      const targetId = document.getElementById('currencyTargetId').value.trim();
      const amount = parseInt(document.getElementById('currencyAmount').value);
      const reason = document.getElementById('currencyReason').value.trim();

      if (!targetId) {
        showResult('currencyResult', `Please enter a ${type === 'gems' ? 'user' : 'server'} ID`, 'error');
        return;
      }

      if (action !== 'check' && (!amount || amount <= 0)) {
        showResult('currencyResult', 'Please enter a valid amount', 'error');
        return;
      }

      try {
        let endpoint = '';
        let body = {};

        if (type === 'gems') {
          if (action === 'check') {
            endpoint = `/api/admin/gems/balance/${targetId}`;
          } else {
            endpoint = `/api/admin/gems/${action}`;
            body = { userId: targetId, amount, reason };
          }
        } else {
          if (action === 'check') {
            endpoint = `/api/admin/server/lookup/${targetId}`;
          } else {
            endpoint = `/api/admin/tokens/${action}`;
            body = { guildId: targetId, amount, reason };
          }
        }

        const options = {
          method: action === 'check' ? 'GET' : 'POST'
        };

        if (action !== 'check') {
          options.headers = {
            'Content-Type': 'application/json',
            'x-csrf': CSRF || ''
          };
          options.body = JSON.stringify(body);
        }

        const response = await fetch(endpoint, options);
        const data = await response.json();
        
        if (response.ok) {
          if (action === 'check') {
            if (type === 'gems') {
              const username = data.discordUser ? (data.discordUser.global_name || data.discordUser.username) : data.name;
              showResult('currencyResult', `${username}: ${data.gems} gems`, 'info');
            } else {
              showResult('currencyResult', `${data.name}: ${data.tokens || 0} tokens`, 'info');
            }
          } else {
            const currency = type === 'gems' ? 'gems' : 'tokens';
            const actionText = action === 'add' ? 'Added' : 'Removed';
            showResult('currencyResult', `${actionText} ${amount} ${currency}. New balance: ${data.newBalance || data.tokens || 0}`, 'success');
            document.getElementById('currencyAmount').value = '';
            document.getElementById('currencyReason').value = '';
          }
        } else {
          showResult('currencyResult', data.message || `Failed to ${action} ${type}`, 'error');
        }
      } catch (error) {
        showResult('currencyResult', 'Network error', 'error');
      }
    }

    async function performItemAction(action) {
      const userId = document.getElementById('itemUserId').value.trim();
      const itemId = document.getElementById('itemId').value.trim();
      const quantity = parseInt(document.getElementById('itemQuantity').value);
      const reason = document.getElementById('itemReason').value.trim();

      if (!userId) {
        showResult('itemResult', 'Please enter a user ID', 'error');
        return;
      }

      if (action === 'clear') {
        if (!confirm(`Are you sure you want to clear ALL items for user ${userId}? This cannot be undone.`)) {
          return;
        }
      } else if (action !== 'check') {
        if (!itemId) {
          showResult('itemResult', 'Please enter an item ID', 'error');
          return;
        }
        if (!quantity || quantity <= 0) {
          showResult('itemResult', 'Please enter a valid quantity', 'error');
          return;
        }
      }

      try {
        let endpoint = '';
        let body = {};
        let method = 'GET';

        if (action === 'check') {
          endpoint = `/api/admin/user/inventory/${userId}`;
        } else if (action === 'add') {
          endpoint = `/api/admin/inventory/add`;
          method = 'POST';
          body = { userId, itemId, quantity, reason };
        } else if (action === 'remove') {
          endpoint = `/api/admin/inventory/remove`;
          method = 'POST';
          body = { userId, itemId, quantity, reason };
        } else if (action === 'clear') {
          endpoint = `/api/admin/inventory/clear`;
          method = 'POST';
          body = { userId, reason };
        }

        const options = { method };
        
        if (method === 'POST') {
          options.headers = {
            'Content-Type': 'application/json',
            'x-csrf': CSRF || ''
          };
          options.body = JSON.stringify(body);
        }

        const response = await fetch(endpoint, options);
        const data = await response.json();
        
        if (response.ok) {
          if (action === 'check') {
            if (data.inventory && data.inventory.length > 0) {
              const itemList = data.inventory.map(item => `${item.itemId}: ${item.qty}`).join('\n');
              const username = data.discordUser ? (data.discordUser.global_name || data.discordUser.username) : 'User';
              showResult('itemResult', `${username} inventory:\n${itemList}`, 'info');
            } else {
              showResult('itemResult', 'User has no items in inventory', 'info');
            }
          } else if (action === 'clear') {
            showResult('itemResult', `Successfully cleared all items for user ${userId}`, 'success');
            document.getElementById('itemReason').value = '';
          } else {
            const actionText = action === 'add' ? 'Added' : 'Removed';
            showResult('itemResult', `${actionText} ${quantity}x ${itemId}. New quantity: ${data.newQuantity || 0}`, 'success');
            document.getElementById('itemId').value = '';
            document.getElementById('itemQuantity').value = '1';
            document.getElementById('itemReason').value = '';
          }
        } else {
          showResult('itemResult', data.message || `Failed to ${action} item`, 'error');
        }
      } catch (error) {
        showResult('itemResult', 'Network error', 'error');
      }
    }

    async function performBossAction(action) {
      const serverId = document.getElementById('bossServerId').value.trim();
      const bossName = document.getElementById('bossName').value.trim();
      const bossTier = parseInt(document.getElementById('bossTier').value);
      const healthMultiplier = parseFloat(document.getElementById('bossHealthMultiplier').value);
      const duration = parseInt(document.getElementById('bossDuration').value);

      if (action !== 'list' && !serverId) {
        showResult('bossResult', 'Please enter a server ID', 'error');
        return;
      }

      if (action === 'spawn') {
        if (!bossTier || bossTier < 1 || bossTier > 5) {
          showResult('bossResult', 'Please enter a valid tier (1-5)', 'error');
          return;
        }
        if (!healthMultiplier || healthMultiplier < 0.1 || healthMultiplier > 5) {
          showResult('bossResult', 'Please enter a valid health multiplier (0.1-5)', 'error');
          return;
        }
        if (!duration || duration < 1 || duration > 480) {
          showResult('bossResult', 'Please enter a valid duration (1-480 minutes)', 'error');
          return;
        }
      }

      if (action === 'spawn' && !confirm(`Are you sure you want to spawn a boss in server ${serverId}?`)) {
        return;
      }

      if (action === 'kill' && !confirm(`Are you sure you want to kill the boss in server ${serverId}?`)) {
        return;
      }

      try {
        let endpoint = '';
        let body = {};
        let method = 'GET';

        if (action === 'list') {
          endpoint = '/api/admin/boss/list';
        } else if (action === 'spawn') {
          endpoint = '/api/admin/boss/spawn';
          method = 'POST';
          body = { 
            serverId, 
            name: bossName || null, 
            tier: bossTier, 
            healthMultiplier, 
            durationMinutes: duration 
          };
        } else if (action === 'kill') {
          endpoint = '/api/admin/boss/kill';
          method = 'POST';
          body = { serverId };
        } else if (action === 'extend') {
          endpoint = '/api/admin/boss/extend';
          method = 'POST';
          body = { serverId, durationMinutes: duration };
        }

        const options = { method };
        
        if (method === 'POST') {
          options.headers = {
            'Content-Type': 'application/json',
            'x-csrf': CSRF || ''
          };
          options.body = JSON.stringify(body);
        }

        const response = await fetch(endpoint, options);
        const data = await response.json();
        
        if (response.ok) {
          if (action === 'list') {
            if (data.bosses && data.bosses.length > 0) {
              const bossList = data.bosses.map(boss => {
                const remainingTime = Math.max(0, Math.floor((boss.expiresAt - Date.now()) / 1000 / 60));
                return `${boss.name} (Tier ${boss.tier}) - ${boss.guildId} - ${remainingTime}m remaining - ${boss.hp}/${boss.maxHp} HP`;
              }).join('\n');
              showResult('bossResult', `Active Bosses (${data.bosses.length}):\n${bossList}`, 'info');
            } else {
              showResult('bossResult', 'No active bosses found', 'info');
            }
          } else if (action === 'spawn') {
            showResult('bossResult', `Successfully spawned boss: ${data.bossName} (Tier ${data.tier}) in server ${serverId}`, 'success');
            document.getElementById('bossName').value = '';
            document.getElementById('bossTier').value = '1';
            document.getElementById('bossHealthMultiplier').value = '1';
            document.getElementById('bossDuration').value = '60';
          } else if (action === 'kill') {
            showResult('bossResult', `Successfully killed boss in server ${serverId}`, 'success');
          } else if (action === 'extend') {
            showResult('bossResult', `Successfully extended boss duration by ${duration} minutes in server ${serverId}`, 'success');
            document.getElementById('bossDuration').value = '60';
          }
        } else {
          showResult('bossResult', data.message || `Failed to ${action} boss`, 'error');
        }
      } catch (error) {
        showResult('bossResult', 'Network error', 'error');
      }
    }

    // Weather generation function
    async function generateWeather() {
      try {
        const response = await fetch('/api/admin/weather/generate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-csrf': CSRF || ''
          }
        });

        const data = await response.json();
        
        if (response.ok) {
          showResult('systemResult', 'Weather generation triggered! New weather events may appear on the map within a few minutes.', 'success');
        } else {
          showResult('systemResult', data.message || 'Failed to generate weather events', 'error');
        }
      } catch (error) {
        showResult('systemResult', 'Network error while generating weather', 'error');
      }
    }

    async function listActiveWeather() {
      try {
        const response = await fetch('/api/weather', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        const data = await response.json();
        
        if (response.ok) {
          const weatherList = document.getElementById('weatherList');
          
          if (!data.weather || data.weather.length === 0) {
            weatherList.innerHTML = '<div style="padding: 15px; background: rgba(52, 152, 219, 0.1); border: 1px solid #3498db; border-radius: 8px; color: #3498db; text-align: center;">No active weather events</div>';
            showResult('weatherResult', 'No active weather events found.', 'success');
            return;
          }
          
          let html = '<h6 style="margin: 0 0 10px 0; color: #3498db;">Active Weather Events (' + data.weather.length + '):</h6>';
          
          data.weather.forEach(weather => {
            const timeLeft = Math.round((weather.expiresAt - Date.now()) / 1000 / 60);
            const blockText = weather.blockTravel ? 'Blocks Travel' : 'Slows Travel';
            
            html += `
              <div style="padding: 10px; margin: 5px 0; background: rgba(17, 24, 39, 0.8); border: 1px solid #4b5563; border-radius: 6px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <strong>${weather.icon} ${weather.name}</strong>
                    <div style="font-size: 12px; color: #9ca3af; margin-top: 2px;">
                      Location: ${weather.centerLat.toFixed(2)}¬∞, ${weather.centerLon.toFixed(2)}¬∞ | Radius: ${weather.radius}km | ${blockText}
                    </div>
                  </div>
                  <div style="text-align: right; font-size: 12px;">
                    <div style="color: #f59e0b;">${timeLeft}m left</div>
                    <div style="color: #6b7280;">ID: ${weather.id}</div>
                  </div>
                </div>
              </div>
            `;
          });
          
          weatherList.innerHTML = html;
          showResult('weatherResult', `Found ${data.weather.length} active weather events.`, 'success');
        } else {
          showResult('weatherResult', data.message || 'Failed to list weather events', 'error');
        }
      } catch (error) {
        showResult('weatherResult', 'Network error while listing weather events', 'error');
      }
    }

    async function clearAllWeather() {
      if (!confirm('Are you sure you want to clear ALL active weather events? This cannot be undone.')) {
        return;
      }
      
      try {
        const response = await fetch('/api/admin/weather/clear', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-csrf': CSRF || ''
          }
        });
        const data = await response.json();
        
        if (response.ok) {
          showResult('weatherResult', `Successfully cleared ${data.count || 0} weather events.`, 'success');
          document.getElementById('weatherList').innerHTML = '';
        } else {
          showResult('weatherResult', data.message || 'Failed to clear weather events', 'error');
        }
      } catch (error) {
        showResult('weatherResult', 'Network error while clearing weather events', 'error');
      }
    }

    async function createWeatherEvent() {
      const type = document.getElementById('weatherType').value;
      const lat = parseFloat(document.getElementById('weatherLat').value);
      const lon = parseFloat(document.getElementById('weatherLon').value);
      const duration = parseInt(document.getElementById('weatherDuration').value);
      const radius = document.getElementById('weatherRadius').value ? parseInt(document.getElementById('weatherRadius').value) : null;
      
      if (isNaN(lat) || isNaN(lon) || isNaN(duration)) {
        showResult('weatherResult', 'Please fill in all required fields with valid numbers.', 'error');
        return;
      }
      
      if (lat < -90 || lat > 90 || lon < -180 || lon > 180) {
        showResult('weatherResult', 'Latitude must be between -90 and 90, longitude between -180 and 180.', 'error');
        return;
      }
      
      if (duration < 10 || duration > 1440) {
        showResult('weatherResult', 'Duration must be between 10 and 1440 minutes.', 'error');
        return;
      }
      
      try {
        const payload = { type, lat, lon, duration };
        if (radius) payload.radius = radius;
        
        const response = await fetch('/api/admin/weather/create', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-csrf': CSRF || ''
          },
          body: JSON.stringify(payload)
        });
        const data = await response.json();
        
        if (response.ok) {
          showResult('weatherResult', `Successfully created ${data.weatherEvent.name} at ${lat}¬∞, ${lon}¬∞!`, 'success');
          // Clear form
          document.getElementById('weatherLat').value = '';
          document.getElementById('weatherLon').value = '';
          document.getElementById('weatherRadius').value = '';
        } else {
          showResult('weatherResult', data.message || 'Failed to create weather event', 'error');
        }
      } catch (error) {
        showResult('weatherResult', 'Network error while creating weather event', 'error');
      }
    }

    async function createRegionalWeather() {
      const type = document.getElementById('regionalWeatherType').value;
      const country = document.getElementById('weatherCountry').value;
      
      if (!country) {
        showResult('weatherResult', 'Please select a country/region.', 'error');
        return;
      }
      
      try {
        const response = await fetch('/api/admin/weather/regional', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-csrf': CSRF || ''
          },
          body: JSON.stringify({ type, country })
        });
        const data = await response.json();
        
        if (response.ok) {
          showResult('weatherResult', `Successfully created ${data.weatherEvent.name} in ${data.region}!`, 'success');
          // Reset form
          document.getElementById('weatherCountry').value = '';
        } else {
          showResult('weatherResult', data.message || 'Failed to create regional weather event', 'error');
        }
      } catch (error) {
        showResult('weatherResult', 'Network error while creating regional weather event', 'error');
      }
    }

    async function removeWeatherEvent() {
      const eventId = document.getElementById('weatherEventId').value.trim();
      
      if (!eventId) {
        showResult('weatherResult', 'Please enter a weather event ID.', 'error');
        return;
      }
      
      try {
        const response = await fetch('/api/admin/weather/remove', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-csrf': CSRF || ''
          },
          body: JSON.stringify({ eventId })
        });
        const data = await response.json();
        
        if (response.ok) {
          showResult('weatherResult', `Successfully removed weather event ${eventId}.`, 'success');
          document.getElementById('weatherEventId').value = '';
        } else {
          showResult('weatherResult', data.message || 'Failed to remove weather event', 'error');
        }
      } catch (error) {
        showResult('weatherResult', 'Network error while removing weather event', 'error');
      }
    }

    // Initialize when page loads
    init();
  </script>
</body>
</html>