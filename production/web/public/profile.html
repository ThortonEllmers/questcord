<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes"/>
  <title>User Profile - QuestCord</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    html, body { 
      height: 100%; 
      margin: 0; 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      line-height: 1.6;
      color: #333;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .header h1 {
      color: white;
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 10px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .header p {
      color: rgba(255,255,255,0.9);
      font-size: 1.1rem;
    }
    
    .back-btn {
      display: inline-block;
      background: rgba(255,255,255,0.2);
      color: white;
      padding: 10px 20px;
      border-radius: 25px;
      text-decoration: none;
      margin-bottom: 20px;
      transition: background 0.3s;
      font-weight: 600;
    }
    
    .back-btn:hover {
      background: rgba(255,255,255,0.3);
      text-decoration: none;
      color: white;
    }
    
    .profile-card {
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      overflow: hidden;
      margin-bottom: 30px;
    }
    
    .profile-header {
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      padding: 30px;
      color: white;
      text-align: center;
      position: relative;
    }
    
    .profile-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .info-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      transition: transform 0.2s ease;
    }
    
    .info-card:hover {
      transform: translateY(-5px);
    }
    
    .card-title {
      font-size: 1.4rem;
      font-weight: 700;
      margin-bottom: 20px;
      color: #333;
      border-bottom: 3px solid #4f46e5;
      padding-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .info-card h3, .info-card p, .info-card span, .info-card div {
      color: #333;
    }
    
    .stat-value {
      color: #4f46e5;
      font-weight: 600;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 25px;
      margin-bottom: 20px;
    }
    
    .avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      border: 4px solid #3498db;
      box-shadow: 0 8px 25px rgba(52, 152, 219, 0.3);
      flex-shrink: 0;
    }
    
    .user-details h2 {
      margin: 0 0 10px 0;
      font-size: 2rem;
      color: #2c3e50;
    }
    
    .role-badge {
      display: inline-block;
      padding: 6px 15px;
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: white;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 15px;
      box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
    }
    
    .role-badge.premium {
      background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
      box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
    }
    
    .role-badge.staff {
      background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
      box-shadow: 0 4px 15px rgba(155, 89, 182, 0.3);
    }
    
    .role-badge.developer {
      background: linear-gradient(135deg, #1abc9c 0%, #16a085 100%);
      box-shadow: 0 4px 15px rgba(26, 188, 156, 0.3);
    }
    
    .stat-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 0;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      font-size: 1.1rem;
    }
    
    .stat-item:last-child {
      border-bottom: none;
    }
    
    .stat-label {
      font-weight: 600;
      color: #34495e;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .stat-value {
      font-weight: 700;
      color: #2c3e50;
      font-size: 1.2rem;
    }
    
    .progress-bar {
      width: 100%;
      height: 12px;
      background: rgba(0, 0, 0, 0.1);
      border-radius: 6px;
      overflow: hidden;
      margin-top: 8px;
    }
    
    .progress-fill {
      height: 100%;
      border-radius: 6px;
      transition: width 0.3s ease;
    }
    
    .health-bar .progress-fill {
      background: linear-gradient(90deg, #e74c3c 0%, #c0392b 100%);
    }
    
    .stamina-bar .progress-fill {
      background: linear-gradient(90deg, #27ae60 0%, #229954 100%);
    }
    
    .achievements-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    
    .info-card {
      margin-bottom: 25px;
    }
    
    .info-card h3 {
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #4f46e5;
    }
    
    .stat-item {
      margin-bottom: 15px;
      padding: 10px 0;
    }
    
    .section-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }
    
    .full-width {
      grid-column: 1 / -1;
      margin-top: 20px;
    }
    
    .achievement-item {
      background: rgba(255, 255, 255, 0.3);
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      border: 2px solid transparent;
      transition: all 0.2s ease;
    }
    
    .achievement-item.unlocked {
      border-color: #f39c12;
      background: rgba(243, 156, 18, 0.1);
    }
    
    .achievement-item .icon {
      font-size: 2rem;
      margin-bottom: 10px;
      display: block;
    }
    
    .achievement-item .name {
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 5px;
    }
    
    .achievement-item .description {
      font-size: 0.9rem;
      color: #7f8c8d;
    }
    
    .inventory-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }
    
    .inventory-item {
      background: rgba(75, 85, 99, 0.3);
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      transition: all 0.2s ease;
      border: 2px solid transparent;
      position: relative;
      overflow: hidden;
    }
    
    .inventory-item:hover {
      background: rgba(75, 85, 99, 0.5);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }
    
    .item-icon {
      font-size: 2rem;
      margin-bottom: 8px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    }
    
    .item-name {
      font-weight: 600;
      color: white !important;
      margin-bottom: 5px;
      font-size: 0.85rem;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
      line-height: 1.2;
      word-wrap: break-word;
      hyphens: auto;
    }
    
    .item-quantity {
      color: rgba(255, 255, 255, 0.8) !important;
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    /* Rarity borders and effects */
    .inventory-item.rarity-common {
      border-color: rgba(156, 163, 175, 0.5);
    }
    
    .inventory-item.rarity-rare {
      border-color: rgba(59, 130, 246, 0.6);
      background: rgba(59, 130, 246, 0.1);
    }
    
    .inventory-item.rarity-epic {
      border-color: rgba(147, 51, 234, 0.6);
      background: rgba(147, 51, 234, 0.1);
    }
    
    .inventory-item.rarity-legendary {
      border-color: rgba(245, 158, 11, 0.6);
      background: rgba(245, 158, 11, 0.1);
      box-shadow: 0 0 10px rgba(245, 158, 11, 0.3);
    }
    
    .inventory-item.rarity-legendary:hover {
      box-shadow: 0 4px 20px rgba(245, 158, 11, 0.5);
    }
    
    .inventory-item.rarity-rare:hover {
      background: rgba(59, 130, 246, 0.2);
    }
    
    .inventory-item.rarity-epic:hover {
      background: rgba(147, 51, 234, 0.2);
    }
    
    .location-info {
      text-align: center;
      padding: 20px;
      background: rgba(52, 152, 219, 0.1);
      border-radius: 10px;
      margin-top: 15px;
    }
    
    .location-current {
      font-size: 1.2rem;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 10px;
    }
    
    .location-coords {
      font-size: 0.9rem;
      color: #7f8c8d;
      font-family: 'Courier New', monospace;
    }
    
    .error-message {
      background: rgba(231, 76, 60, 0.1);
      border: 2px solid #e74c3c;
      color: #c0392b;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      margin: 20px 0;
      font-weight: 600;
    }
    
    .loading {
      text-align: center;
      padding: 50px;
      font-size: 1.2rem;
      color: #7f8c8d;
    }
    
    @media (max-width: 768px) {
      .profile-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      .user-info {
        flex-direction: column;
        text-align: center;
        gap: 20px;
      }
      
      .header h1 {
        font-size: 2rem;
      }
      
      .container {
        padding: 15px;
      }
      
      .achievements-grid {
        grid-template-columns: 1fr;
      }
      
      .inventory-grid {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      }
    }
    
    /* User Search Styles */
    .user-search-section {
      margin: 20px 0;
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    .user-search-section h3 {
      margin: 0 0 15px 0;
      color: #333 !important;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.3rem;
      font-weight: 700 !important;
      border-bottom: 2px solid #4f46e5;
      padding-bottom: 10px;
    }
    
    .search-form {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .search-input {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #ddd;
      border-radius: 12px;
      font-size: 1rem;
      background: white;
      color: #333 !important;
      transition: all 0.3s ease;
    }
    
    .search-input::placeholder {
      color: #999 !important;
    }
    
    .search-input:focus {
      outline: none;
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.3);
      background: white;
    }
    
    .search-btn {
      padding: 12px 24px;
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      color: white !important;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
    }
    
    .search-btn:hover {
      background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
    }
    
    .search-result {
      margin-top: 15px;
      padding: 15px;
      border-radius: 12px;
      background: rgba(0, 0, 0, 0.05);
      border: 1px solid #ddd;
    }
    
    .search-result:empty {
      display: none;
    }
    
    .search-result p {
      color: #333 !important;
      margin: 0;
    }
    
    .user-preview {
      display: flex;
      align-items: center;
      gap: 15px;
      margin: 15px 0;
    }
    
    .user-preview img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid rgba(75, 85, 99, 0.5);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }
    
    .user-preview .user-info {
      flex: 1;
    }
    
    .user-preview .user-info strong {
      font-size: 1.1rem;
      color: #333 !important;
      font-weight: 700 !important;
    }
    
    .user-preview .user-info small {
      color: #666 !important;
      font-size: 0.9rem;
    }
    
    .view-profile-btn {
      display: inline-block;
      width: 100%;
      text-align: center;
      padding: 12px;
      background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
      color: white !important;
      text-decoration: none;
      border-radius: 10px;
      font-weight: 600;
      margin-top: 15px;
      transition: all 0.3s ease;
    }
    
    .view-profile-btn:hover {
      background: linear-gradient(135deg, #8e44ad 0%, #7d3c98 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(155, 89, 182, 0.3);
      color: white !important;
      text-decoration: none;
    }
    
    @media (max-width: 768px) {
      .search-form {
        flex-direction: column;
      }
      
      .user-search-section {
        padding: 20px;
        margin: 15px 0;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div style="text-align: center; margin-bottom: 20px;">
      <a href="/" class="back-btn">← Back to Map</a>
    </div>
    
    <div class="header">
      <h1>User Profile</h1>
      <p>View your adventure statistics and achievements</p>
    </div>
    
    <!-- User Search Section -->
    <div class="user-search-section" id="userSearchSection" style="display: none;">
      <h3>
        <span>Search</span>
        Find Other User Profiles
      </h3>
      <div class="search-form">
        <input type="text" id="userSearchInput" class="search-input" placeholder="Enter Discord User ID (e.g., 123456789012345678)">
        <button class="search-btn" id="userSearchBtn">Search Profile</button>
      </div>
      <div id="userSearchResult" class="search-result"></div>
    </div>
    
    <div id="loading" class="loading">
      Loading profile data...
    </div>
    
    <div id="error" class="error-message" style="display: none;">
      Failed to load profile data. Please try again or sign in.
    </div>
    
    <div id="profile" style="display: none;">
      <div class="profile-card">
        <div class="profile-header">
          <img id="userAvatar" class="avatar" src="" alt="User Avatar">
          <div class="user-name" id="username"></div>
          <div class="user-id" id="userRole"></div>
          <div class="user-status" id="currentLocation"></div>
        </div>
        
        <div class="content">
          <div class="section-grid">
            <div class="info-card">
              <h3>Player Stats</h3>
              <div class="stat-item">
                <div class="stat-label">
                  <span>Health</span>
                  Health
                </div>
                <div class="stat-value" id="healthValue">0/100</div>
              </div>
              <div class="progress-bar health-bar">
                <div class="progress-fill" id="healthProgress" style="width: 0%"></div>
              </div>
              
              <div class="stat-item">
                <div class="stat-label">
                  <span>Stamina</span>
                  Stamina
                </div>
                <div class="stat-value" id="staminaValue">0/100</div>
              </div>
              <div class="progress-bar stamina-bar">
                <div class="progress-fill" id="staminaProgress" style="width: 0%"></div>
              </div>
              
              <div class="stat-item">
                <div class="stat-label">
                  <span>Gems</span>
                  Gems
                </div>
                <div class="stat-value" id="gemsValue">0</div>
              </div>
            </div>
            
            <div class="info-card">
              <h3>Adventure Stats</h3>
              <div class="stat-item">
                <div class="stat-label">
                  <span>Locations</span>
                  Servers Visited
                </div>
                <div class="stat-value" id="serversVisited">0</div>
              </div>
              
              <div class="stat-item">
                <div class="stat-label">
                  <span>Distance</span>
                  Total Distance
                </div>
                <div class="stat-value" id="totalDistance">0 km</div>
              </div>
              
              <div class="stat-item">
                <div class="stat-label">
                  <span>Time</span>
                  Time Traveled
                </div>
                <div class="stat-value" id="timeTraveled">0 hours</div>
              </div>
            </div>
            
            <div class="info-card">
              <h3>Combat Stats</h3>
              <div class="stat-item">
                <div class="stat-label">
                  <span>Bosses</span>
                  Bosses Defeated
                </div>
                <div class="stat-value" id="bossesKilled">0</div>
              </div>
              
              <div class="stat-item">
                <div class="stat-label">
                  <span>Wins</span>
                  Win Rate
                </div>
                <div class="stat-value" id="winRate">0%</div>
              </div>
              
              <div class="stat-item">
                <div class="stat-label">
                  <span>Weapon</span>
                  Best Weapon
                </div>
                <div class="stat-value" id="bestWeapon">None</div>
              </div>
            </div>
          </div>
          
          <div class="info-card full-width">
            <h3>Achievements</h3>
            <div id="achievementsList" class="achievements-grid">
              <!-- Achievements will be populated here -->
            </div>
          </div>
          
          <div class="info-card full-width">
            <h3>Inventory</h3>
            <div id="inventoryList" class="inventory-grid">
              <!-- Inventory items will be populated here -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    async function loadProfile() {
      try {
        // Check if we're viewing another user's profile
        const pathParts = window.location.pathname.split('/');
        const viewingUserId = pathParts.length >= 3 && pathParts[1] === 'profile' ? pathParts[2] : null;
        
        let response, data;
        
        if (viewingUserId) {
          // Loading another user's profile
          response = await fetch(`/api/profile/${viewingUserId}`);
          data = await response.json();
          
          if (!response.ok || !data.user) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').textContent = data.error || 'User profile not found or private.';
            document.getElementById('error').style.display = 'block';
            return;
          }
          
          // Update page title to show it's another user's profile
          document.title = `${data.user.username}'s Profile - QuestCord`;
          document.querySelector('.header h1').textContent = `${data.user.username}'s Profile`;
        } else {
          // Loading own profile
          response = await fetch('/api/whoami');
          data = await response.json();
          
          if (!data.user) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').textContent = 'Please sign in to view your profile.';
            document.getElementById('error').style.display = 'block';
            return;
          }
        }
        
        // Load additional profile data
        let analyticsResponse, achievementsResponse;
        
        if (viewingUserId) {
          // For other users, additional data should already be included in the profile response
          analyticsResponse = { ok: true, json: async () => data.analytics || {} };
          achievementsResponse = { ok: true, json: async () => data.achievements || {} };
        } else {
          // For own profile, load additional data separately
          [analyticsResponse, achievementsResponse] = await Promise.all([
            fetch('/api/analytics').catch(() => ({ ok: false })),
            fetch('/api/achievements').catch(() => ({ ok: false }))
          ]);
        }
        
        const analytics = analyticsResponse.ok ? await analyticsResponse.json() : null;
        const achievements = achievementsResponse.ok ? await achievementsResponse.json() : null;
        
        populateProfile(data, analytics, achievements);
        
      } catch (error) {
        console.error('Failed to load profile:', error);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
      }
    }
    
    function populateProfile(data, analytics, achievements) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('profile').style.display = 'block';
      
      // User Info  
      let avatar;
      const pathParts = window.location.pathname.split('/');
      const viewingUserId = pathParts.length >= 3 && pathParts[1] === 'profile' ? pathParts[2] : null;
      
      if (viewingUserId) {
        // Viewing another user - API returns full URL or null
        avatar = data.user.avatar || 'https://cdn.discordapp.com/embed/avatars/0.png';
      } else {
        // Viewing own profile - API returns avatar hash, need to construct URL
        avatar = data.user.avatar ? 
          `https://cdn.discordapp.com/avatars/${data.user.id}/${data.user.avatar}.png` : 
          'https://cdn.discordapp.com/embed/avatars/0.png';
      }
      document.getElementById('userAvatar').src = avatar;
      document.getElementById('username').textContent = data.user.username;
      
      // Role Badge  
      const roleBadge = document.getElementById('userRole');
      const roleLevel = data.roleLevel || 'User';
      roleBadge.textContent = `ID: ${data.user.id} • Role: ${roleLevel}`;
      
      // Location Status
      const locationEl = document.getElementById('currentLocation');
      
      if (data.travel && data.travel.arrivalAt && Date.now() < data.travel.arrivalAt) {
        locationEl.textContent = `Traveling: ${data.travel.from.name} → ${data.travel.to.name}`;
        locationEl.className = 'user-status';
      } else if (data.currentLocationServer) {
        locationEl.textContent = `Currently at: ${data.currentLocationServer.name}`;
        locationEl.className = 'user-status';
      } else {
        locationEl.textContent = 'Location Unknown';
        locationEl.className = 'user-status';
      }
      
      // Player Stats
      const player = data.player || {};
      const health = Math.max(0, Math.min(100, player.health || 0));
      const stamina = Math.max(0, Math.min(100, player.stamina || 0));
      
      document.getElementById('healthValue').textContent = `${health}/100`;
      document.getElementById('healthProgress').style.width = `${health}%`;
      document.getElementById('staminaValue').textContent = `${stamina}/100`;
      document.getElementById('staminaProgress').style.width = `${stamina}%`;
      document.getElementById('gemsValue').textContent = player.gems || 0;
      
      // Adventure Stats from analytics
      if (analytics) {
        document.getElementById('serversVisited').textContent = analytics.uniqueServers || 0;
        document.getElementById('totalDistance').textContent = `${(analytics.totalDistance || 0).toFixed(1)} km`;
        document.getElementById('timeTraveled').textContent = `${Math.round((analytics.totalTravelTime || 0) / 3600000)} hours`;
        document.getElementById('bossesKilled').textContent = analytics.bossKills || 0;
        document.getElementById('winRate').textContent = analytics.battles > 0 ? 
          `${Math.round((analytics.wins / analytics.battles) * 100)}%` : '0%';
        document.getElementById('bestWeapon').textContent = analytics.bestWeapon || 'None';
      }
      
      // Achievements
      populateAchievements(achievements);
      
      // Inventory
      populateInventory(data.inventory || []);
    }
    
    function populateAchievements(achievements) {
      const container = document.getElementById('achievementsList');
      container.innerHTML = '';
      
      const defaultAchievements = [
        { id: 'first_travel', name: 'First Journey', description: 'Complete your first travel', icon: '🚀', unlocked: false },
        { id: 'explorer', name: 'Explorer', description: 'Visit 10 different servers', icon: '🗺️', unlocked: false },
        { id: 'boss_slayer', name: 'Boss Slayer', description: 'Defeat your first boss', icon: '⚔️', unlocked: false },
        { id: 'collector', name: 'Collector', description: 'Collect 50 items', icon: '🎒', unlocked: false }
      ];
      
      const achievementList = achievements?.achievements || defaultAchievements;
      
      achievementList.forEach(achievement => {
        const item = document.createElement('div');
        item.className = `achievement-item ${achievement.unlocked ? 'unlocked' : ''}`;
        item.innerHTML = `
          <span class="icon">${achievement.icon}</span>
          <div class="name">${achievement.name}</div>
          <div class="description">${achievement.description}</div>
        `;
        container.appendChild(item);
      });
    }
    
    // Function to format item names and get images
    function formatItem(itemId) {
      // Dictionary of item translations and images
      const itemData = {
        // Equipment
        'equipment_flaming_sword_1': { name: 'Flaming Sword', image: '🗡️', rarity: 'rare' },
        'equipment_ice_staff_1': { name: 'Ice Staff', image: '🪄', rarity: 'rare' },
        'equipment_dragon_shield_1': { name: 'Dragon Shield', image: '🛡️', rarity: 'epic' },
        'equipment_mystic_bow_1': { name: 'Mystic Bow', image: '🏹', rarity: 'rare' },
        'equipment_healing_potion_1': { name: 'Healing Potion', image: '🧪', rarity: 'common' },
        'equipment_mana_potion_1': { name: 'Mana Potion', image: '🔮', rarity: 'common' },
        'equipment_steel_sword_1': { name: 'Steel Sword', image: '⚔️', rarity: 'common' },
        'equipment_leather_armor_1': { name: 'Leather Armor', image: '🥼', rarity: 'common' },
        'equipment_iron_helmet_1': { name: 'Iron Helmet', image: '⛑️', rarity: 'common' },
        
        // Resources
        'resource_wood': { name: 'Wood', image: '🪵', rarity: 'common' },
        'resource_stone': { name: 'Stone', image: '🪨', rarity: 'common' },
        'resource_iron_ore': { name: 'Iron Ore', image: '⛏️', rarity: 'common' },
        'resource_gold_ore': { name: 'Gold Ore', image: '🥇', rarity: 'rare' },
        'resource_crystal': { name: 'Crystal', image: '💎', rarity: 'epic' },
        'resource_herbs': { name: 'Herbs', image: '🌿', rarity: 'common' },
        
        // Consumables
        'consumable_bread': { name: 'Bread', image: '🍞', rarity: 'common' },
        'consumable_meat': { name: 'Meat', image: '🥩', rarity: 'common' },
        'consumable_apple': { name: 'Apple', image: '🍎', rarity: 'common' },
        'consumable_cheese': { name: 'Cheese', image: '🧀', rarity: 'common' },
        
        // Special items
        'special_treasure_map': { name: 'Treasure Map', image: '🗺️', rarity: 'rare' },
        'special_golden_key': { name: 'Golden Key', image: '🗝️', rarity: 'epic' },
        'special_ancient_scroll': { name: 'Ancient Scroll', image: '📜', rarity: 'legendary' },
        'special_magic_gem': { name: 'Magic Gem', image: '💎', rarity: 'epic' },
        
        // Boss drops
        'boss_dragon_scale': { name: 'Dragon Scale', image: '🐲', rarity: 'legendary' },
        'boss_phoenix_feather': { name: 'Phoenix Feather', image: '🔥', rarity: 'legendary' },
        'boss_demon_horn': { name: 'Demon Horn', image: '👹', rarity: 'legendary' },
        'boss_kraken_tentacle': { name: 'Kraken Tentacle', image: '🐙', rarity: 'legendary' }
      };
      
      const item = itemData[itemId];
      if (item) {
        return item;
      }
      
      // Fallback: try to parse the item name
      let name = itemId.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
      
      // Remove common prefixes
      name = name.replace(/^(Equipment|Resource|Consumable|Special|Boss)\s/, '');
      
      // Remove version numbers
      name = name.replace(/\s\d+$/, '');
      
      // Default image based on item type
      let image = '📦'; // Default box
      let rarity = 'common';
      
      if (itemId.startsWith('equipment_')) {
        if (itemId.includes('sword') || itemId.includes('blade')) image = '⚔️';
        else if (itemId.includes('bow') || itemId.includes('arrow')) image = '🏹';
        else if (itemId.includes('staff') || itemId.includes('wand')) image = '🪄';
        else if (itemId.includes('shield')) image = '🛡️';
        else if (itemId.includes('armor') || itemId.includes('chestplate')) image = '🥼';
        else if (itemId.includes('helmet') || itemId.includes('hat')) image = '⛑️';
        else if (itemId.includes('potion')) image = '🧪';
        else image = '⚔️';
        rarity = 'rare';
      } else if (itemId.startsWith('resource_')) {
        if (itemId.includes('wood')) image = '🪵';
        else if (itemId.includes('stone') || itemId.includes('rock')) image = '🪨';
        else if (itemId.includes('ore')) image = '⛏️';
        else if (itemId.includes('crystal') || itemId.includes('gem')) image = '💎';
        else if (itemId.includes('herb') || itemId.includes('plant')) image = '🌿';
        else image = '🪨';
      } else if (itemId.startsWith('consumable_')) {
        if (itemId.includes('bread')) image = '🍞';
        else if (itemId.includes('meat')) image = '🥩';
        else if (itemId.includes('fruit') || itemId.includes('apple')) image = '🍎';
        else if (itemId.includes('cheese')) image = '🧀';
        else image = '🍎';
      } else if (itemId.startsWith('boss_')) {
        image = '👑';
        rarity = 'legendary';
      }
      
      return { name, image, rarity };
    }
    
    function populateInventory(inventory) {
      const container = document.getElementById('inventoryList');
      container.innerHTML = '';
      
      if (inventory.length === 0) {
        container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #7f8c8d; padding: 20px;">No items in inventory</div>';
        return;
      }
      
      inventory.forEach(item => {
        const itemInfo = formatItem(item.itemId);
        const itemEl = document.createElement('div');
        itemEl.className = `inventory-item rarity-${itemInfo.rarity}`;
        itemEl.innerHTML = `
          <div class="item-icon">${itemInfo.image}</div>
          <div class="item-name">${itemInfo.name}</div>
          <div class="item-quantity">x${item.qty}</div>
        `;
        container.appendChild(itemEl);
      });
    }
    
    // User search functionality
    function setupUserSearch() {
      const userSearchSection = document.getElementById('userSearchSection');
      const userSearchBtn = document.getElementById('userSearchBtn');
      const userSearchInput = document.getElementById('userSearchInput');
      const userSearchResult = document.getElementById('userSearchResult');
      
      // Show search section for logged-in users
      const pathParts = window.location.pathname.split('/');
      const viewingOtherUser = pathParts.length >= 3 && pathParts[1] === 'profile' ? pathParts[2] : null;
      
      if (!viewingOtherUser) {
        // Only show search when viewing own profile
        fetch('/api/whoami')
          .then(response => response.json())
          .then(data => {
            if (data.user) {
              userSearchSection.style.display = 'block';
            }
          })
          .catch(() => {
            // If whoami fails, don't show search
          });
      }
      
      if (userSearchBtn && userSearchInput && userSearchResult) {
        userSearchBtn.addEventListener('click', async () => {
          const userId = userSearchInput.value.trim();
          if (!userId) {
            userSearchResult.innerHTML = '<p style="color: #e74c3c; margin: 0;">Please enter a Discord User ID</p>';
            return;
          }
          
          if (!/^\d{17,19}$/.test(userId)) {
            userSearchResult.innerHTML = '<p style="color: #e74c3c; margin: 0;">Invalid Discord User ID format. Must be 17-19 digits.</p>';
            return;
          }
          
          userSearchResult.innerHTML = '<p style="margin: 0;">Searching...</p>';
          
          try {
            const response = await fetch(`/api/profile/${userId}`);
            const data = await response.json();
            
            if (response.ok && data.user) {
              userSearchResult.innerHTML = `
                <div class="user-preview">
                  <img src="${data.user.avatar || 'https://cdn.discordapp.com/embed/avatars/0.png'}" alt="Avatar">
                  <div class="user-info">
                    <strong>${data.user.username}</strong>
                    <br><small>${data.roleLevel || 'Member'}</small>
                  </div>
                </div>
                <a href="/profile/${userId}" class="view-profile-btn">
                  View ${data.user.username}'s Profile
                </a>
              `;
              userSearchInput.value = '';
            } else {
              userSearchResult.innerHTML = `<p style="color: #e74c3c; margin: 0;">${data.error || 'User not found or profile is private'}</p>`;
            }
          } catch (error) {
            userSearchResult.innerHTML = '<p style="color: #e74c3c; margin: 0;">Search failed. Please try again.</p>';
          }
        });
        
        // Allow Enter key to trigger search
        userSearchInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            userSearchBtn.click();
          }
        });
      }
    }
    
    // Auto-refresh functionality for live stats
    let refreshInterval = null;
    let currentAnalytics = null;
    
    function startAutoRefresh() {
      // Clear any existing interval
      if (refreshInterval) {
        clearInterval(refreshInterval);
      }
      
      // Set up 60-second refresh interval for stats
      refreshInterval = setInterval(async () => {
        await refreshStats();
      }, 60000); // 60 seconds
      
      console.log('Auto-refresh started: Adventure stats will update every 60 seconds');
    }
    
    function stopAutoRefresh() {
      if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
        console.log('Auto-refresh stopped');
      }
    }
    
    async function refreshStats() {
      try {
        console.log('Refreshing adventure stats...');
        
        const pathParts = window.location.pathname.split('/');
        const viewingUserId = pathParts.length >= 3 && pathParts[1] === 'profile' ? pathParts[2] : null;
        
        let analyticsResponse;
        
        if (viewingUserId) {
          // For viewing other user's profile, fetch their complete profile data
          const response = await fetch(`/api/profile/${viewingUserId}`);
          if (response.ok) {
            const data = await response.json();
            analyticsResponse = { ok: true, json: async () => data.analytics || {} };
          } else {
            analyticsResponse = { ok: false };
          }
        } else {
          // For own profile, fetch analytics directly
          analyticsResponse = await fetch('/api/analytics').catch(() => ({ ok: false }));
        }
        
        if (analyticsResponse.ok) {
          const analytics = await analyticsResponse.json();
          
          // Check if stats have changed
          const statsChanged = !currentAnalytics || 
            analytics.uniqueServers !== currentAnalytics.uniqueServers ||
            analytics.totalDistance !== currentAnalytics.totalDistance ||
            analytics.totalTravelTime !== currentAnalytics.totalTravelTime ||
            analytics.bossKills !== currentAnalytics.bossKills ||
            analytics.battles !== currentAnalytics.battles ||
            analytics.wins !== currentAnalytics.wins ||
            analytics.bestWeapon !== currentAnalytics.bestWeapon;
          
          if (statsChanged) {
            // Update the displayed stats
            document.getElementById('serversVisited').textContent = analytics.uniqueServers || 0;
            document.getElementById('totalDistance').textContent = `${(analytics.totalDistance || 0).toFixed(1)} km`;
            document.getElementById('timeTraveled').textContent = `${Math.round((analytics.totalTravelTime || 0) / 3600000)} hours`;
            document.getElementById('bossesKilled').textContent = analytics.bossKills || 0;
            document.getElementById('winRate').textContent = analytics.battles > 0 ? 
              `${Math.round((analytics.wins / analytics.battles) * 100)}%` : '0%';
            document.getElementById('bestWeapon').textContent = analytics.bestWeapon || 'None';
            
            // Store current analytics for comparison
            currentAnalytics = analytics;
            
            console.log('Adventure stats updated with fresh data');
            
            // Add a subtle visual indicator that stats were updated
            const adventureCard = document.querySelector('.profile-card');
            if (adventureCard) {
              adventureCard.style.transform = 'translateY(-2px)';
              adventureCard.style.boxShadow = '0 12px 40px rgba(52, 152, 219, 0.3)';
              setTimeout(() => {
                adventureCard.style.transform = '';
                adventureCard.style.boxShadow = '';
              }, 1000);
            }
          } else {
            console.log('No changes in adventure stats');
          }
        } else {
          console.warn('Failed to refresh analytics data');
        }
      } catch (error) {
        console.error('Error refreshing stats:', error);
      }
    }
    
    // Modify the existing populateProfile function to store initial analytics
    function populateProfileWithRefresh(data, analytics, achievements) {
      populateProfile(data, analytics, achievements);
      
      // Store initial analytics for comparison
      currentAnalytics = analytics;
      
      // Start auto-refresh after profile is loaded
      startAutoRefresh();
    }

    // Load profile on page load
    setupUserSearch();
    
    // Store original loadProfile function
    const originalLoadProfile = loadProfile;
    
    // Override loadProfile to use the refresh-enabled version
    loadProfile = async function() {
      try {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('error').style.display = 'none';
        document.getElementById('profile').style.display = 'none';
        
        let response, data;
        const pathParts = window.location.pathname.split('/');
        const viewingUserId = pathParts.length >= 3 && pathParts[1] === 'profile' ? pathParts[2] : null;
        
        if (viewingUserId) {
          // Loading another user's profile
          response = await fetch(`/api/profile/${viewingUserId}`);
          data = await response.json();
          
          if (!response.ok || !data.user) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').textContent = data.error || 'User profile not found or private.';
            document.getElementById('error').style.display = 'block';
            return;
          }
          
          document.title = `${data.user.username}'s Profile - QuestCord`;
          document.querySelector('.header h1').textContent = `${data.user.username}'s Profile`;
        } else {
          // Loading own profile
          response = await fetch('/api/whoami');
          data = await response.json();
          
          if (!data.user) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').textContent = 'Please sign in to view your profile.';
            document.getElementById('error').style.display = 'block';
            return;
          }
        }
        
        // Load additional profile data
        let analyticsResponse, achievementsResponse;
        
        if (viewingUserId) {
          analyticsResponse = { ok: true, json: async () => data.analytics || {} };
          achievementsResponse = { ok: true, json: async () => data.achievements || {} };
        } else {
          [analyticsResponse, achievementsResponse] = await Promise.all([
            fetch('/api/analytics').catch(() => ({ ok: false })),
            fetch('/api/achievements').catch(() => ({ ok: false }))
          ]);
        }
        
        const analytics = analyticsResponse.ok ? await analyticsResponse.json() : null;
        const achievements = achievementsResponse.ok ? await achievementsResponse.json() : null;
        
        // Use the new refresh-enabled populate function
        populateProfileWithRefresh(data, analytics, achievements);
        
      } catch (error) {
        console.error('Failed to load profile:', error);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
      }
    };
    
    // Clean up interval when page is unloaded
    window.addEventListener('beforeunload', stopAutoRefresh);
    
    // Load the profile
    loadProfile();
  </script>
</body>
</html>