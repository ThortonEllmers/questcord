const { SlashCommandBuilder, EmbedBuilder } = require('discord.js');
const { getUserPrefix } = require('../utils/roles');
const { isBanned, regenStamina } = require('./_guard');
const { db } = require('../utils/store_sqlite');

module.exports = {
  data: new SlashCommandBuilder()
    .setName('analytics')
    .setDescription('View detailed battle analytics and performance statistics')
    .addSubcommand(sc => sc
      .setName('battles')
      .setDescription('View your battle performance statistics'))
    .addSubcommand(sc => sc
      .setName('weapons')
      .setDescription('Compare weapon effectiveness and damage output'))
    .addSubcommand(sc => sc
      .setName('history')
      .setDescription('View recent battle history and damage trends')),

  async execute(interaction) {
    const userPrefix = await getUserPrefix(interaction.client, interaction.user);
    if (isBanned(interaction.user.id)) {
      return interaction.reply({ content: `${userPrefix} You are banned from using this bot.`, ephemeral: true });
    }
    regenStamina(interaction.user.id);

    const subcommand = interaction.options.getSubcommand();
    const userId = interaction.user.id;

    if (subcommand === 'battles') {
      // Get overall battle statistics
      const battleStats = db.prepare(`
        SELECT 
          COUNT(*) as totalFights,
          SUM(damage) as totalDamage,
          AVG(damage) as avgDamage,
          MAX(damage) as maxDamage,
          COUNT(DISTINCT bossId) as uniqueBosses
        FROM battle_analytics
        WHERE userId = ?
      `).get(userId) || {};

      // Get recent activity (last 7 days)
      const weekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
      const recentActivity = db.prepare(`
        SELECT COUNT(*) as recentFights, SUM(damage) as recentDamage
        FROM battle_analytics
        WHERE userId = ? AND timestamp > ?
      `).get(userId, weekAgo) || {};

      // Get player's boss kill count from players table
      const player = db.prepare('SELECT bossKills FROM players WHERE userId = ?').get(userId);
      const bossKills = player?.bossKills || 0;

      const analyticsEmbed = new EmbedBuilder()
        .setTitle('âš”ï¸ğŸ“Š **BATTLE ANALYTICS** ğŸ“Šâš”ï¸')
        .setDescription('ğŸ“ˆ *Comprehensive analysis of your combat performance* ğŸ“ˆ')
        .setColor(0xE74C3C)
        .setAuthor({ 
          name: `${userPrefix} - Combat Analyst`,
          iconURL: interaction.user.displayAvatarURL() 
        });

      if (battleStats.totalFights === 0) {
        analyticsEmbed.addFields(
          {
            name: 'ğŸ“­ **No Battle Data**',
            value: 'â€¢ Join your first boss battle with `/boss`\\nâ€¢ Fight alongside other players for glory\\nâ€¢ Earn gems, loot, and track your progress\\nâ€¢ Build your combat reputation!',
            inline: false
          },
          {
            name: 'ğŸ¯ **Get Started**',
            value: 'â€¢ **Find Bosses**: Check active servers for boss spawns\\nâ€¢ **Team Up**: Battles are more effective with allies\\nâ€¢ **Weapon Choice**: Different weapons have varying effectiveness\\nâ€¢ **Track Progress**: Return here to see your improvement',
            inline: false
          }
        );
      } else {
        // Main battle statistics
        analyticsEmbed.addFields(
          {
            name: 'âš”ï¸ **Combat Record**',
            value: `**${battleStats.totalFights}** total attacks
**${bossKills}** bosses defeated
**${battleStats.uniqueBosses}** unique enemies
**${recentActivity.recentFights || 0}** fights this week`,
            inline: true
          },
          {
            name: 'ğŸ’¥ **Damage Statistics**',
            value: `**${battleStats.totalDamage?.toLocaleString() || 0}** total damage
**${Math.round(battleStats.avgDamage || 0)}** average per hit
**${battleStats.maxDamage?.toLocaleString() || 0}** highest single hit
**${Math.round(recentActivity.recentDamage / (recentActivity.recentFights || 1) || 0)}** recent average`,
            inline: true
          },
          {
            name: 'ğŸ“ˆ **Performance Metrics**',
            value: `**${Math.round((battleStats.totalDamage || 0) / (battleStats.totalFights || 1))}** damage/fight
**${(recentActivity.recentFights || 0 / 7).toFixed(1)}** fights/day
**${Math.round((recentActivity.recentDamage || 0) / 7)}** daily damage
${battleStats.maxDamage >= 1000 ? 'ğŸ† **Elite Warrior**' : battleStats.maxDamage >= 500 ? 'â­ **Skilled Fighter**' : 'ğŸ”° **Learning Fighter**'}`,
            inline: true
          }
        );

        // Performance trends
        const improvement = recentActivity.recentFights > 0 ? 
          ((recentActivity.recentDamage / recentActivity.recentFights) / battleStats.avgDamage - 1) * 100 : 0;

        analyticsEmbed.addFields({
          name: 'ğŸ“Š **Performance Analysis**',
          value: `â€¢ **Consistency**: ${battleStats.avgDamage >= 100 ? 'Excellent' : battleStats.avgDamage >= 50 ? 'Good' : 'Developing'} damage output
â€¢ **Recent Form**: ${improvement > 10 ? 'ğŸ“ˆ Improving' : improvement < -10 ? 'ğŸ“‰ Declining' : 'â¡ï¸ Steady'} (${improvement > 0 ? '+' : ''}${improvement.toFixed(1)}%)
â€¢ **Activity Level**: ${recentActivity.recentFights >= 10 ? 'Very Active' : recentActivity.recentFights >= 5 ? 'Active' : 'Casual'} fighter
â€¢ **Boss Success**: ${(bossKills / battleStats.uniqueBosses * 100).toFixed(0)}% kill participation rate`,
          inline: false
        });
      }

      const achievementIcon = bossKills >= 50 ? 'ğŸ‘‘' : bossKills >= 10 ? 'ğŸ…' : bossKills >= 1 ? 'âš”ï¸' : 'ğŸ”°';
      const achievementTitle = bossKills >= 50 ? 'Legendary Warrior' :
        bossKills >= 10 ? 'Monster Hunter' :
        bossKills >= 1 ? 'Boss Slayer' : 'Aspiring Fighter';
      const rank = battleStats.totalFights >= 100 ? 'Veteran' : 
        battleStats.totalFights >= 50 ? 'Experienced' : 
        battleStats.totalFights >= 10 ? 'Regular' : 'Newcomer';
      
      analyticsEmbed.addFields({
        name: 'ğŸ–ï¸ **Battle Achievements**',
        value: `${achievementIcon} **${achievementTitle}**
â€¢ **Progress**: ${bossKills}/50 boss kills
â€¢ **Rank**: ${rank}
â€¢ **Specialization**: View \`/analytics weapons\` for weapon mastery`,
        inline: false
      });

      analyticsEmbed.setFooter({ 
        text: `âš”ï¸ Battle data updates after each boss fight â€¢ QuestCord Analytics`,
        iconURL: interaction.client.user.displayAvatarURL()
      });

      return interaction.reply({ embeds: [analyticsEmbed] });
    }

    if (subcommand === 'weapons') {
      // Get weapon usage statistics
      const weaponStats = db.prepare(`
        SELECT 
          weapon,
          COUNT(*) as uses,
          SUM(damage) as totalDamage,
          AVG(damage) as avgDamage,
          MAX(damage) as maxDamage
        FROM battle_analytics
        WHERE userId = ? AND weapon IS NOT NULL
        GROUP BY weapon
        ORDER BY totalDamage DESC
      `).all(userId);

      const weaponsEmbed = new EmbedBuilder()
        .setTitle('âš”ï¸ğŸ—¡ï¸ **WEAPON MASTERY** ğŸ—¡ï¸âš”ï¸')
        .setDescription('ğŸ¯ *Analysis of your weapon effectiveness and preferences* ğŸ¯')
        .setColor(0x8E44AD)
        .setAuthor({ 
          name: `${userPrefix} - Weapon Master`,
          iconURL: interaction.user.displayAvatarURL() 
        });

      if (weaponStats.length === 0) {
        weaponsEmbed.addFields(
          {
            name: 'ğŸ—¡ï¸ **No Weapon Data**',
            value: 'â€¢ Equip weapons before entering battle\
â€¢ Different weapons have varying damage ranges\
â€¢ Track which weapons work best for you\
â€¢ Build your arsenal strategically!',
            inline: false
          },
          {
            name: 'âš”ï¸ **Weapon Tips**',
            value: 'â€¢ **Equip First**: Use `/equip <weapon>` before fights\
â€¢ **Experiment**: Try different weapon types\
â€¢ **Upgrade**: Craft better weapons as you progress\
â€¢ **Specialize**: Focus on weapons that suit your style',
            inline: false
          }
        );
      } else {
        // Weapon performance summary
        const totalWeaponDamage = weaponStats.reduce((sum, w) => sum + w.totalDamage, 0);
        const totalWeaponUses = weaponStats.reduce((sum, w) => sum + w.uses, 0);
        const favoriteWeapon = weaponStats[0];

        weaponsEmbed.addFields(
          {
            name: 'ğŸ† **Weapon Portfolio**',
            value: `**${weaponStats.length}** weapons mastered\
**${totalWeaponUses}** total attacks\
**${totalWeaponDamage?.toLocaleString()}** combined damage\
**${Math.round(totalWeaponDamage / totalWeaponUses)}** overall average`,
            inline: true
          },
          {
            name: 'â­ **Favorite Weapon**',
            value: `**${favoriteWeapon.weapon}**\
${favoriteWeapon.uses} uses (${Math.round(favoriteWeapon.uses / totalWeaponUses * 100)}%)\
${favoriteWeapon.totalDamage?.toLocaleString()} damage\
${Math.round(favoriteWeapon.avgDamage)} avg per hit`,
            inline: true
          },
          {
            name: 'ğŸ’ª **Combat Style**',
            value: weaponStats.length >= 5 ? 'ğŸŒŸ **Versatile Fighter**\
Masters multiple weapons' : 
                   weaponStats.length >= 3 ? 'âš”ï¸ **Balanced Warrior**\
Uses variety of weapons' :
                   'ğŸ—¡ï¸ **Specialist**\
Focuses on few weapons',
            inline: true
          }
        );

        // Top weapons performance
        const topWeapons = weaponStats.slice(0, 5).map((weapon, index) => {
          const rankEmoji = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', '4ï¸âƒ£', '5ï¸âƒ£'][index];
          const efficiency = Math.round(weapon.avgDamage);
          const usage = Math.round(weapon.uses / totalWeaponUses * 100);
          return `${rankEmoji} **${weapon.weapon}**\
ğŸ“Š ${efficiency} avg dmg â€¢ ğŸ¯ ${usage}% usage â€¢ âš¡ ${weapon.maxDamage} max hit`;
        }).join('\
\
');

        weaponsEmbed.addFields({
          name: 'ğŸ… **Weapon Leaderboard**',
          value: topWeapons,
          inline: false
        });

        // Weapon recommendations
        const bestDamage = Math.max(...weaponStats.map(w => w.avgDamage));
        const mostUsed = weaponStats[0];
        const recommendations = [];

        if (bestDamage > mostUsed.avgDamage) {
          const bestWeapon = weaponStats.find(w => w.avgDamage === bestDamage);
          recommendations.push(`â€¢ Consider using **${bestWeapon.weapon}** more (highest avg damage: ${Math.round(bestDamage)})`);
        }

        if (weaponStats.length < 3) {
          recommendations.push('â€¢ Try experimenting with more weapon types for versatility');
        }

        if (recommendations.length === 0) {
          recommendations.push('â€¢ Your weapon usage is well optimized!');
        }

        weaponsEmbed.addFields({
          name: 'ğŸ’¡ **Performance Insights**',
          value: recommendations.join('\
') + '\
â€¢ Use `/craft` to create stronger weapons\
â€¢ Different bosses may have resistances to certain weapon types',
          inline: false
        });
      }

      weaponsEmbed.setFooter({ 
        text: `ğŸ—¡ï¸ Master your arsenal for maximum effectiveness â€¢ QuestCord Weapons`,
        iconURL: interaction.client.user.displayAvatarURL()
      });

      return interaction.reply({ embeds: [weaponsEmbed] });
    }

    if (subcommand === 'history') {
      // Get recent battle history
      const battleHistory = db.prepare(`
        SELECT damage, weapon, timestamp, bossId
        FROM battle_analytics
        WHERE userId = ?
        ORDER BY timestamp DESC
        LIMIT 20
      `).all(userId);

      const historyEmbed = new EmbedBuilder()
        .setTitle('ğŸ“œâš”ï¸ **BATTLE HISTORY** âš”ï¸ğŸ“œ')
        .setDescription('â° *Your recent combat encounters and damage progression* â°')
        .setColor(0x2ECC71)
        .setAuthor({ 
          name: `${userPrefix} - Combat Log`,
          iconURL: interaction.user.displayAvatarURL() 
        });

      if (battleHistory.length === 0) {
        historyEmbed.addFields(
          {
            name: 'ğŸ“­ **Empty Battle Log**',
            value: 'â€¢ No recorded battles yet\
â€¢ Start fighting bosses to build your history\
â€¢ Track your improvement over time\
â€¢ Analyze your combat patterns',
            inline: false
          },
          {
            name: 'ğŸ”¥ **Join the Action**',
            value: 'â€¢ Use `/boss` to find active boss battles\
â€¢ Fight alongside other adventurers\
â€¢ Each battle adds to your combat record\
â€¢ Watch your skills improve over time!',
            inline: false
          }
        );
      } else {
        // Recent battles summary
        const recentDamage = battleHistory.slice(0, 5).reduce((sum, b) => sum + b.damage, 0) / Math.min(5, battleHistory.length);
        const olderDamage = battleHistory.slice(5, 10).reduce((sum, b) => sum + b.damage, 0) / Math.max(1, battleHistory.slice(5, 10).length);
        const trend = recentDamage > olderDamage ? 'ğŸ“ˆ Improving' : recentDamage < olderDamage ? 'ğŸ“‰ Declining' : 'â¡ï¸ Steady';

        historyEmbed.addFields(
          {
            name: 'ğŸ“Š **Recent Performance**',
            value: `**${battleHistory.length}** recorded battles\
**${Math.round(recentDamage)}** recent avg damage\
**${trend}** performance trend\
**${Math.max(...battleHistory.map(b => b.damage))}** highest recent hit`,
            inline: true
          },
          {
            name: 'â° **Activity Timeline**',
            value: `Last fight: ${new Date(battleHistory[0].timestamp).toLocaleDateString()}\
Most active weapon: **${getBestWeapon(battleHistory)}**\
Fighting consistency: ${getActivityLevel(battleHistory)}`,
            inline: true
          }
        );

        // Recent battle log
        const battleLog = battleHistory.slice(0, 8).map((battle, index) => {
          const date = new Date(battle.timestamp);
          const timeAgo = Math.floor((Date.now() - battle.timestamp) / (1000 * 60 * 60 * 24));
          const weapon = battle.weapon || 'Bare Hands';
          
          return `**${index + 1}.** ${battle.damage.toLocaleString()} dmg with ${weapon}\
ğŸ“… ${timeAgo === 0 ? 'Today' : `${timeAgo}d ago`} â€¢ Boss #${battle.bossId || 'Unknown'}`;
        }).join('\
\
');

        historyEmbed.addFields({
          name: 'âš”ï¸ **Combat Log**',
          value: battleLog,
          inline: false
        });

        if (battleHistory.length > 8) {
          historyEmbed.addFields({
            name: 'ğŸ“‹ **Extended History**',
            value: `... and **${battleHistory.length - 8}** more battles\
Use \`/analytics battles\` for complete statistics`,
            inline: false
          });
        }

        // Performance insights
        const damageVariance = getVariance(battleHistory.map(b => b.damage));
        const consistency = damageVariance < 100 ? 'Very Consistent' : damageVariance < 500 ? 'Fairly Consistent' : 'Variable';

        historyEmbed.addFields({
          name: 'ğŸ¯ **Performance Insights**',
          value: `â€¢ **Consistency**: ${consistency} damage output\
â€¢ **Recent Form**: ${Math.round(recentDamage)} avg damage (last 5 fights)\
â€¢ **Weapon Preference**: Favors ${getBestWeapon(battleHistory)}\
â€¢ **Activity Pattern**: ${getActivityLevel(battleHistory)} fighter`,
          inline: false
        });
      }

      historyEmbed.setFooter({ 
        text: `âš”ï¸ Battle history helps track your combat improvement â€¢ QuestCord Analytics`,
        iconURL: interaction.client.user.displayAvatarURL()
      });

      return interaction.reply({ embeds: [historyEmbed] });
    }
  }
};

// Helper functions
function getBestWeapon(battles) {
  const weaponCounts = {};
  battles.forEach(battle => {
    const weapon = battle.weapon || 'Bare Hands';
    weaponCounts[weapon] = (weaponCounts[weapon] || 0) + 1;
  });
  
  return Object.keys(weaponCounts).reduce((a, b) => weaponCounts[a] > weaponCounts[b] ? a : b, 'None');
}

function getActivityLevel(battles) {
  if (battles.length === 0) return 'Inactive';
  
  const daysSinceFirst = Math.floor((Date.now() - battles[battles.length - 1].timestamp) / (1000 * 60 * 60 * 24)) || 1;
  const battlesPerDay = battles.length / daysSinceFirst;
  
  if (battlesPerDay >= 2) return 'Very Active';
  if (battlesPerDay >= 1) return 'Active';
  if (battlesPerDay >= 0.5) return 'Regular';
  return 'Casual';
}

function getVariance(numbers) {
  const avg = numbers.reduce((sum, n) => sum + n, 0) / numbers.length;
  const variance = numbers.reduce((sum, n) => sum + Math.pow(n - avg, 2), 0) / numbers.length;
  return Math.sqrt(variance);
}